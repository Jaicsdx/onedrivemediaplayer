<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>OneDrive Cloud Media Player</title>

<!-- Plyr (nice media controls) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/plyr@3/dist/plyr.css"/>
<script defer src="https://cdn.jsdelivr.net/npm/plyr@3/dist/plyr.min.js"></script>

<!-- Lightweight compression so share links stay shorter -->
<script defer src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>

<style>
  :root{
    --bg:#0b1220; --panel:#101827; --panel-brd:#1f2937; --text:#e5e7eb; --muted:#9ca3af;
    --accent:#38bdf8; --mutedBtn:#64748b; --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  a{color:inherit}

  .wrap{max-width:1120px;margin:0 auto;padding:14px}

  header{
    position:sticky;top:0;z-index:30;background:linear-gradient(180deg,var(--bg),rgba(11,18,32,.7));
    border-bottom:1px solid rgba(255,255,255,.06);backdrop-filter: blur(6px);
  }
  .bar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;padding:10px 0}
  .brand{display:flex;align-items:center;gap:10px}
  .brand .logo{font-size:26px}
  .brand .title{font-weight:900;letter-spacing:.2px}

  .add-form{display:flex;gap:8px;align-items:center;flex:1;min-width:280px}
  .in{flex:1;min-width:160px;background:#0e162c;border:1px solid var(--panel-brd);color:var(--text);
       padding:10px 12px;border-radius:10px;outline:none}
  .btn{border:0;border-radius:10px;padding:10px 12px;font-weight:800;cursor:pointer}
  .btn-add{background:var(--accent);color:#06121f}
  .btn-clear{background:var(--mutedBtn);color:#fff}

  .toolrow{display:flex;gap:8px;flex-wrap:wrap}
  .btn-ghost{background:#0f1a2f;border:1px solid #1b2947;color:#c8d6ee}

  .row{display:grid;grid-template-columns:1.4fr .9fr;gap:14px;margin-top:14px}
  @media (max-width: 900px){ .row{grid-template-columns:1fr;} }

  .panel{background:var(--panel);border:1px solid var(--panel-brd);border-radius:16px;box-shadow:var(--shadow)}
  .panel-head{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid rgba(255,255,255,.06)}
  .panel-body{padding:12px}
  .ph-title{font-weight:800}
  .ph-status{font-size:12px;color:var(--muted)}

  .player-wrap{position:relative;border-radius:14px;overflow:hidden;background:#04070f}
  .player-hint{position:absolute;right:10px;top:10px;font-size:12px;color:var(--muted);background:rgba(255,255,255,.06);
               padding:4px 8px;border-radius:999px}
  .plyr--video{--plyr-color-main: var(--accent)}
  video{width:100%;height:62vh;background:#000}
  iframe.embed{width:100%;height:62vh;border:0}
  @media (max-width: 900px){ video,iframe.embed{height:48vh} }

  .list{display:grid;gap:8px}
  .item{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;background:#0d1729;border:1px solid #16223a;padding:10px 12px;border-radius:12px}
  .item:hover{border-color:#2b3e65}
  .badge{width:38px;height:38px;border-radius:12px;background:#0b1324;display:grid;place-items:center;font-weight:800;color:#9cccf3}
  .itxt{min-width:0}
  .title{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .meta{font-size:12px;color:#9ca3af;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .i-actions{display:flex;gap:6px}
  .xbtn{border:0;background:#0f1a2f;border:1px solid #1b2947;color:#c8d6ee;padding:6px 8px;border-radius:8px;cursor:pointer;font-weight:700}
  .xbtn.copy{background:#14223d}
  .xbtn.danger{background:#2a0f12;border-color:#45161a;color:#fbb2b8}
  .empty{color:#9ca3af;text-align:center;padding:18px 6px}
  .hint{font-size:12px;color:#9ca3af;text-align:center;margin-top:8px}
</style>
</head>
<body>

<header>
  <div class="wrap bar">
    <div class="brand">
      <div class="logo">▶️</div>
      <div class="title">OneDrive Cloud Media</div>
    </div>

    <form id="addForm" class="add-form" autocomplete="off">
      <input id="titleInput" class="in" placeholder="Title (optional)"/>
      <input id="urlInput"   class="in" placeholder="Paste OneDrive link (file)"/>
      <button class="btn btn-add" type="submit">Add</button>
      <button class="btn btn-clear" type="button" id="clearAll">Clear</button>
    </form>
  </div>

  <div class="wrap toolrow" style="padding-bottom:10px;">
    <button class="btn btn-ghost" id="shareLink">Share link</button>
    <button class="btn btn-ghost" id="copyLink">Copy link</button>
    <button class="btn btn-ghost" id="exportJson">Export JSON</button>
    <label class="btn btn-ghost" style="cursor:pointer;">
      Import JSON
      <input type="file" id="importJson" accept="application/json" hidden/>
    </label>
  </div>
</header>

<main class="wrap row">
  <!-- Player -->
  <section class="panel">
    <div class="panel-head">
      <div class="ph-title">Player</div>
      <div class="ph-status"><span id="status">Ready</span></div>
    </div>
    <div class="panel-body">
      <div class="player-wrap">
        <div class="player-hint" id="hint">HTML5 player</div>
        <video id="video" playsinline controls></video>
        <iframe id="iframe" class="embed" hidden allow="autoplay; fullscreen"></iframe>
      </div>
    </div>
  </section>

  <!-- Playlist -->
  <section class="panel">
    <div class="panel-head">
      <div class="ph-title">Playlist</div>
      <div class="toolrow">
        <input id="filter" class="in" placeholder="Filter…"/>
      </div>
    </div>
    <div class="panel-body">
      <div id="list" class="list"></div>
      <div id="empty" class="empty" hidden>No items. Paste a OneDrive link above and press Add.</div>
      <div class="hint">Playlist is saved locally. Use Share/Export to take it to other devices or your TV.</div>
    </div>
  </section>
</main>

<footer class="wrap" style="color:#9ca3af;font-size:12px;text-align:center;padding:16px 0 22px">
  Tip: Long OneDrive links with <code>resid</code> &amp; <code>authkey</code> stream best. If direct play is blocked, the app auto-falls back to OneDrive’s web player.
</footer>

<script>
/* ====================== Utilities & Storage ====================== */
const $ = (s,r=document)=>r.querySelector(s);
const store = {
  get(){ try{ return JSON.parse(localStorage.getItem('od.playlist')||'[]'); }catch{ return []; } },
  set(arr){ localStorage.setItem('od.playlist', JSON.stringify(arr)); }
};
/* Only keep minimal fields for portability */
function serialize(list){ return list.map(({title,original})=>({title,original})); }
function deserialize(arr){
  return (arr||[]).map(x=>makeItem({title:x.title, url:x.original}));
}

/* Short code generator for tidy UI */
function shortCodeFrom(url){
  let h = 0;
  for (let i=0; i<url.length; i++) { h = (h*31 + url.charCodeAt(i)) >>> 0; }
  return `LC-${h.toString(36).toUpperCase().slice(0,4)}`;
}

/* OneDrive link parsing for direct/iframe */
function parseOneDrive(url){
  try{
    const u = new URL(url);
    const resid   = u.searchParams.get('resid');
    const authkey = u.searchParams.get('authkey') || u.searchParams.get('authKey');
    if(resid && authkey){
      return {
        direct: `https://onedrive.live.com/download?resid=${encodeURIComponent(resid)}&authkey=${encodeURIComponent(authkey)}`,
        embed:  `https://onedrive.live.com/embed?resid=${encodeURIComponent(resid)}&authkey=${encodeURIComponent(authkey)}&em=2`
      };
    }
    if (u.pathname.includes('/download') || u.pathname.includes('download.aspx')){
      return { direct: url, embed: null };
    }
    if (u.hostname.endsWith('1drv.ms') || u.hostname.endsWith('onedrive.live.com')){
      return { direct: null, embed: url };
    }
  }catch(e){}
  return { direct: null, embed: url };
}

/* Playlist item */
function makeItem({title,url}){
  const parsed = parseOneDrive(url);
  return {
    id: crypto.randomUUID(),
    title: (title && title.trim()) ? title.trim() : shortCodeFrom(url),
    code: shortCodeFrom(url),
    original: url,
    direct: parsed.direct,
    embed:  parsed.embed
  };
}

/* ====================== Player ====================== */
let plyr = null;
const videoEl = $('#video');
const iframeEl = $('#iframe');
const statusEl = $('#status');
const hintEl = $('#hint');

function useHtml5(src){
  iframeEl.hidden = true; iframeEl.src = 'about:blank';
  videoEl.hidden = false; videoEl.src = src;
  hintEl.textContent = 'HTML5 player'; statusEl.textContent = 'Streaming via direct link';
  if(!plyr){
    plyr = new Plyr(videoEl, {
      controls: ['play-large','play','progress','current-time','duration','mute','volume','settings','pip','airplay','fullscreen'],
      ratio: '16:9'
    });
  }
}
function useIframe(src){
  try{ plyr && plyr.pause(); }catch{}
  videoEl.hidden = true; videoEl.removeAttribute('src');
  iframeEl.hidden = false; iframeEl.src = src;
  hintEl.textContent = 'OneDrive web player'; statusEl.textContent = 'Using OneDrive web player';
}
async function playItem(it){
  if(it.direct){
    useHtml5(it.direct);
    try{ await videoEl.play(); return; }catch(e){ /* fallback below */ }
  }
  useIframe(it.embed || it.original);
}

/* ====================== UI: List render ====================== */
function renderList(filter=''){
  const list = store.get();
  const listEl = $('#list');
  const emptyEl = $('#empty');
  listEl.innerHTML = '';

  const q = (filter||'').trim().toLowerCase();
  const filtered = list.filter(it => (it.title||'').toLowerCase().includes(q) || (it.code||'').toLowerCase().includes(q));
  if(filtered.length === 0){ emptyEl.hidden = false; return; }
  emptyEl.hidden = true;

  filtered.forEach((it, idx)=>{
    const row = document.createElement('div');
    row.className = 'item';
    row.innerHTML = `
      <div class="badge">${idx+1}</div>
      <div class="itxt">
        <div class="title" title="${it.title}">${it.title}</div>
        <div class="meta">Code: ${it.code}</div>
      </div>
      <div class="i-actions">
        <button class="xbtn" data-act="play" data-id="${it.id}">Play</button>
        <button class="xbtn copy" data-act="copy" data-id="${it.id}" title="Copy original URL">Copy</button>
        <button class="xbtn danger" data-act="del" data-id="${it.id}">Del</button>
      </div>
    `;
    row.addEventListener('click', async (ev)=>{
      const btn = ev.target.closest('button[data-act]');
      const listNow = store.get();
      const current = listNow.find(x=>x.id===it.id);
      if(!current) return;
      if(btn){
        const act = btn.dataset.act;
        if(act==='play'){ await playItem(current); }
        if(act==='copy'){ navigator.clipboard?.writeText(current.original); statusEl.textContent='Copied original link'; }
        if(act==='del'){ store.set(listNow.filter(x=>x.id!==it.id)); renderList($('#filter').value||''); }
        return;
      }
      await playItem(current);
    });
    listEl.appendChild(row);
  });
}

/* ====================== Share / Export / Import ====================== */
/* Share Link: compress playlist JSON into URL param ?pl= */
function buildShareUrl(){
  const base = window.location.origin + window.location.pathname; // keep it clean
  const payload = JSON.stringify(serialize(store.get()));
  // compress to base64 with LZString for shorter URLs
  const packed = LZString.compressToEncodedURIComponent(payload);
  return `${base}?pl=${packed}`;
}
function loadFromUrlParam(){
  const params = new URLSearchParams(location.search);
  const pl = params.get('pl');
  if(!pl) return false;
  try{
    const json = LZString.decompressFromEncodedURIComponent(pl);
    const data = JSON.parse(json);
    store.set(deserialize(data));
    return true;
  }catch(e){ console.warn('Failed to parse shared playlist', e); return false; }
}
function exportJson(){
  const blob = new Blob([JSON.stringify(serialize(store.get()), null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'playlist.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(a.href);
}
function importJsonFile(file){
  const reader = new FileReader();
  reader.onload = () => {
    try{
      const data = JSON.parse(reader.result);
      store.set(deserialize(data));
      renderList($('#filter').value||'');
      statusEl.textContent = 'Playlist imported';
    }catch(e){ alert('Invalid JSON'); }
  };
  reader.readAsText(file);
}

/* ====================== Wire up ====================== */
document.addEventListener('DOMContentLoaded', ()=>{
  // If URL contains a shared playlist, load it and wipe the param so the URL stays clean
  const loaded = loadFromUrlParam();
  if(loaded){
    // replaceState to remove ?pl=... after load (keeps the page clean)
    history.replaceState(null, '', window.location.pathname);
  }

  // Seed demo if empty
  if(store.get().length===0){
    store.set([
      makeItem({ title:"(demo) Sample clip", url:"https://1drv.ms/v/s!A..." }) // replace with your link
    ]);
  }
  renderList();

  $('#addForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const title = $('#titleInput').value;
    const url   = $('#urlInput').value.trim();
    if(!url){ $('#urlInput').focus(); return; }
    const list = store.get();
    list.push(makeItem({title,url}));
    store.set(list);
    $('#titleInput').value=''; $('#urlInput').value='';
    renderList($('#filter').value||'');
    statusEl.textContent = 'Added to playlist';
  });

  $('#clearAll').addEventListener('click', ()=>{
    if(confirm('Clear all items?')){ store.set([]); renderList(''); statusEl.textContent='Cleared'; }
  });
  $('#filter').addEventListener('input', e=>renderList(e.target.value));

  // Share / Export / Import buttons
  $('#shareLink').addEventListener('click', ()=>{
    const url = buildShareUrl();
    // If the device supports native share (nice for TV sticks / phones)
    if(navigator.share){
      navigator.share({ title:'My Media Playlist', url }).catch(()=>{});
    }else{
      // fallback: open in a new tab so you can bookmark it
      window.open(url, '_blank');
    }
  });
  $('#copyLink').addEventListener('click', ()=>{
    const url = buildShareUrl();
    navigator.clipboard?.writeText(url);
    statusEl.textContent = 'Share link copied';
  });
  $('#exportJson').addEventListener('click', exportJson);
  $('#importJson').addEventListener('change', (e)=>{
    const f = e.target.files && e.target.files[0];
    if(f) importJsonFile(f);
    e.target.value = '';
  });

  // Auto-play first on load
  const first = store.get()[0]; if(first) playItem(first);
});
</script>
</body>
</html>
